{% extends 'base.html' %}
{% block title %}Sala {{ room }}{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Sala: <span class="badge bg-secondary">{{ room }}</span></h3>
    <!-- Agrupando o nome e o novo botão -->
    <div class="d-flex align-items-center">
        <span class="me-3">Olá, <strong>{{ name }}</strong>!</span>
        <!-- botão de saida do chat -->
        <a href="{{ url_for('home') }}" class="btn btn-danger btn-sm">Sair da Sala</a>
    </div>
</div>

<div class="chat-box" id="chat-box">
    <!-- As mensagens serão inseridas aqui pelo JavaScript -->
</div>

<div class="message-form">
    <input type="text" id="message-input" class="form-control" placeholder="Digite sua mensagem...">
    <button id="send-button" class="btn btn-primary ms-2">Enviar</button>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const socket = io();
        const chatBox = document.getElementById('chat-box');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');

        function displayMessage(messageText) {
            const messageElement = document.createElement('div');
            messageElement.textContent = messageText;
            // Adiciona as novas mensagens no final, para a ordem ficar correta.
            chatBox.appendChild(messageElement);
            // Auto-scroll para a última mensagem
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        
        // Modificação na função original para exibir a mensagem na ordem correta
        function displayOwnMessage(messageText) {
             const messageElement = document.createElement('div');
             // Adiciona uma classe para poder estilizar suas próprias mensagens de forma diferente, se quiser
             messageElement.classList.add('my-message'); 
             messageElement.textContent = messageText;
             chatBox.appendChild(messageElement);
             chatBox.scrollTop = chatBox.scrollHeight;
        }

        socket.on('connect', () => {
            console.log("Conectado ao gateway via WebSocket!");
        });

        socket.on('server_message', (msg) => {
            displayMessage(msg.data);
        });

        function sendMessage() {
            const message = messageInput.value.trim();
            if (message) {
                // Exibe a sua própria mensagem
                displayOwnMessage(`[Você] ${message}`);
                
                // Envia a mensagem para os outros
                socket.emit('client_message', { data: message });
                
                messageInput.value = '';
                messageInput.focus();
            }
        }

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    });
</script>
{% endblock %}