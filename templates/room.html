{% extends 'base.html' %}
{% block title %}Sala {{ room }}{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Sala: <span class="badge bg-secondary">{{ room }}</span></h3>
    <span>Olá, <strong>{{ name }}</strong>!</span>
</div>
<div class="chat-box" id="chat-box">
    <!-- As mensagens serão inseridas aqui pelo JavaScript -->
</div>
<div class="message-form">
    <input type="text" id="message-input" class="form-control" placeholder="Digite sua mensagem...">
    <button id="send-button" class="btn btn-primary ms-2">Enviar</button>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const socket = io();
        const chatBox = document.getElementById('chat-box');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');

        // --- FUNÇÃO PARA EXIBIR MENSAGENS ---
        // Criamos uma função para evitar repetir código.
        function displayMessage(messageText) {
            const messageElement = document.createElement('div');
            messageElement.textContent = messageText;
            // Insere a nova mensagem no topo da caixa de chat
            chatBox.prepend(messageElement); 
        }

        socket.on('connect', () => {
            console.log("Conectado ao gateway via WebSocket!");
        });

        // Ouve por 'server_message' do gateway (mensagens de outras pessoas)
        socket.on('server_message', (msg) => {
            displayMessage(msg.data);
        });

        // --- FUNÇÃO PARA ENVIAR MENSAGENS ---
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message) {
                // 1. Exibe a sua própria mensagem imediatamente na tela
                displayMessage(`[Você] ${message}`);
                
                // 2. Envia 'client_message' para o gateway (para que os outros vejam)
                socket.emit('client_message', { data: message });
                
                // 3. Limpa o campo e foca nele novamente
                messageInput.value = '';
                messageInput.focus();
            }
        }

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    });
</script>
{% endblock %}